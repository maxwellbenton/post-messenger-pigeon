class Store{constructor(){this._registry={},this._prefix=""}get prefix(){return this._prefix}set prefix(e){this._prefix=e}get registry(){return this._registry}register(e,s){this._registry[e]=s}unregister(e){delete this._registry[e]}isRegistered(e){return!!this._registry[e]}}class Messenger{constructor(){this._store=new Store,window.addEventListener("message",(async e=>{console.log("MESSAGE RECEIVED",e);const{data:s,origin:r,source:t}=e,i=JSON.parse(s);if(this.isRegistered(i.messageName)){let e;try{e=await this.store.registry[i.messageName]({origin:r,source:t,data:i}),console.log("END OF MESSAGE LISTENER CALLBACK",e)}catch(e){console.log("Error in callback",e)}}}))}createMessage(e,s,r){const t=JSON.stringify({messageName:e,...s&&Object.keys(s).length&&{data:s},...r&&{origin:r}});return console.log("CREATED MESSAGE",t),t}register(e,s){this._store.register(e,s)}unregister(e){this._store.unregister(e)}isRegistered(e){return this._store.isRegistered(e)}get registry(){this._store.registry}messagePrefix(){return this._store.prefix}get store(){return this._store}setMessagePrefix(e){this._store.prefix=e}async _listen(e,s,r,t=!0){const i=this.store.prefix+"."+e;let o,n;console.log("LISTENING",i,s);const a=new Promise(((o,a)=>{this.register(i,(async i=>{t&&this.unregister(e);const{data:a,origin:g,source:c}=i;if(!r?.domain||r.domain===g){if(console.log("CALLBACK",s),n=await s(a),console.log("CALLBACK RESULT",n),!a.messageName.endsWith(".acknowledged")){const e=this.createMessage(a.messageName+".acknowledged",n);this._broadcast(c,e,g)}t&&o(n)}}))})),g=new Promise(((e,s)=>{o=()=>{this.unregister(i),e()}}));return Object.assign(Promise.race([a,g]),{cancel:o})}bootstrap(e){this.setMessagePrefix(e),this._listen("handshake",(e=>{console.log("INSIDE HANDSHAKE CALLBACK",e);const s=e?.data?.messageName;return{messageName:s,registered:this.isRegistered(s)}}),{},!1)}_broadcast(e,s,r){console.log("BROADCASTING",s,r),e.postMessage(s,r)}on(e,s={},r=(e=>e)){if(!e)throw new Error("Message name is required");return this._listen(e,r,s,!1)}async once(e,s={},r=(e=>e)){if(!e)throw new Error("Message name is required");return this._listen(e,r,s,!0)}async send(e,s,r){if(!e)throw new Error("Message name is required");const t=this.store.prefix,i=t+"."+e;console.log("STARTING SEND",i,s,r);let o=new Promise(((o,n)=>{s?.timeout&&setTimeout((()=>n(new Error("Timeout"))),s.timeout),this._listen("handshake.acknowledged",(e=>e),{window:window.parent},!0).then((t=>{if(console.log("HANDSHAKE ACKNOWLEDGED",t),!t?.data?.registered)throw new Error(`No listener registered for ${i}`);{this._listen(e+".acknowledged",(e=>e),s,!0).then((e=>{console.log("MESSAGE ACKNOWLEDGED",e),o(e)}));const t=this.createMessage(i,r);console.log("SENDING MESSAGE",t),this._broadcast(s.window,t,s.origin)}}));const a=this.createMessage(t+".handshake",{messageName:i});console.log("SENDING HANDSHAKE",a),this._broadcast(s.window,a,s.origin)}));return await o}}const messenger=new Messenger,PostMessengerPigeon={bootstrap:messenger.bootstrap,on:messenger.on,once:messenger.once,send:messenger.send};window.PostMessengerPigeon=PostMessengerPigeon,modules.export=PostMessengerPigeon;
